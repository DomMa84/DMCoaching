---
// ContactForm.astro v18.9 (Layout-Fix + E-Mail Integration)
// ✅ WICHTIG: Layout v1.2.8 CSS-Klassen beibehalten!
// ✅ ÄNDERUNGEN v18.9:
// - Layout v1.2.8 CSS-Klassen wiederhergestellt
// - E-Mail-Status Integration beibehalten
// - Originaldesign nicht verändert
// - Enhanced UX nur im JavaScript

const { showTitle = true, leadForm = false } = Astro.props;
---

<!-- ✅ ORIGINAL CONTACT TILE DESIGN (Layout v1.2.8) -->
<div class="value-tile-improved">
  {showTitle && (
    <div class="text-center mb-8">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
        {leadForm ? '🎯 Interesse an unseren Leistungen?' : '📞 Kontakt aufnehmen'}
      </h2>
      <p class="text-gray-600 dark:text-gray-300">
        {leadForm 
          ? 'Lassen Sie uns über Ihre Herausforderungen sprechen. Wir melden uns schnellstmöglich bei Ihnen.'
          : 'Haben Sie Fragen oder möchten Sie einen Beratungstermin vereinbaren? Schreiben Sie uns!'
        }
      </p>
    </div>
  )}

  <!-- ✅ KONTAKTFORMULAR v18.9 mit Original-Layout -->
  <form 
    id="contactForm"
    x-data="contactFormData()"
    @submit.prevent="submitForm()"
    class="space-y-6"
  >
    <!-- ✅ HONEYPOT SCHUTZ (unsichtbar) -->
    <input 
      type="text" 
      name="website" 
      x-model="formData.honeypot"
      style="display: none !important;" 
      tabindex="-1" 
      autocomplete="off"
    >

    <!-- ✅ NAME FIELD -->
    <div>
      <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
        Name <span class="text-red-500">*</span>
      </label>
      <input
        type="text"
        id="name"
        name="name"
        x-model="formData.name"
        class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-gold focus:border-transparent dark:bg-gray-700 dark:text-white transition-colors duration-200"
        :class="{ 'border-red-500 focus:ring-red-500': errors.name }"
        placeholder="Ihr vollständiger Name"
        required
        maxlength="100"
        @input="clearFieldError('name')"
      >
      <div x-show="errors.name" x-text="errors.name" class="text-red-500 text-sm mt-1"></div>
    </div>

    <!-- ✅ EMAIL FIELD -->
    <div>
      <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
        E-Mail-Adresse <span class="text-red-500">*</span>
      </label>
      <input
        type="email"
        id="email"
        name="email"
        x-model="formData.email"
        class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-gold focus:border-transparent dark:bg-gray-700 dark:text-white transition-colors duration-200"
        :class="{ 'border-red-500 focus:ring-red-500': errors.email }"
        placeholder="ihre.email@beispiel.de"
        required
        maxlength="255"
        @input="clearFieldError('email')"
      >
      <div x-show="errors.email" x-text="errors.email" class="text-red-500 text-sm mt-1"></div>
    </div>

    <!-- ✅ PHONE FIELD -->
    <div>
      <label for="phone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
        Telefonnummer <span class="text-red-500">*</span>
      </label>
      <input
        type="tel"
        id="phone"
        name="phone"
        x-model="formData.phone"
        class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-gold focus:border-transparent dark:bg-gray-700 dark:text-white transition-colors duration-200"
        :class="{ 'border-red-500 focus:ring-red-500': errors.phone }"
        placeholder="+49 123 456789"
        required
        maxlength="25"
        @input="clearFieldError('phone')"
      >
      <div x-show="errors.phone" x-text="errors.phone" class="text-red-500 text-sm mt-1"></div>
    </div>

    <!-- ✅ MESSAGE FIELD -->
    <div>
      <label for="message" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
        {leadForm ? 'Beschreiben Sie Ihre Herausforderung' : 'Nachricht'}
        {!leadForm && <span class="text-gray-500">(optional)</span>}
      </label>
      <textarea
        id="message"
        name="message"
        x-model="formData.message"
        class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-gold focus:border-transparent dark:bg-gray-700 dark:text-white transition-colors duration-200 resize-none"
        :class="{ 'border-red-500 focus:ring-red-500': errors.message }"
        placeholder={leadForm 
          ? "Beschreiben Sie kurz Ihre aktuelle Situation und wobei wir Ihnen helfen können..."
          : "Ihre Nachricht an uns..."
        }
        rows="4"
        maxlength="2000"
        @input="clearFieldError('message')"
      ></textarea>
      <div x-show="errors.message" x-text="errors.message" class="text-red-500 text-sm mt-1"></div>
      <div class="text-right text-sm text-gray-500 mt-1">
        <span x-text="formData.message.length"></span>/2000 Zeichen
      </div>
    </div>

    <!-- ✅ GDPR CHECKBOX (Original Design) -->
    <div>
      <label class="flex items-start space-x-3">
        <input
          type="checkbox"
          name="gdprConsent"
          x-model="formData.gdprConsent"
          class="mt-1 h-4 w-4 text-primary-gold focus:ring-primary-gold border-gray-300 dark:border-gray-600 rounded"
          :class="{ 'border-red-500': errors.gdprConsent }"
          required
          @change="clearFieldError('gdprConsent')"
        >
        <span class="text-sm text-gray-600 dark:text-gray-300">
          Ich stimme der <a href="/datenschutz" target="_blank" class="text-primary-gold hover:underline">Datenschutzerklärung</a> zu und bin damit einverstanden, dass meine Daten zur Bearbeitung meiner Anfrage gespeichert werden. <span class="text-red-500">*</span>
        </span>
      </label>
      <div x-show="errors.gdprConsent" x-text="errors.gdprConsent" class="text-red-500 text-sm mt-1"></div>
    </div>

    <!-- ✅ SUBMIT BUTTON (Original Design) -->
    <button
      type="submit"
      class="w-full bg-primary-gold hover:bg-primary-gold-dark text-white font-bold py-4 px-6 rounded-lg transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2"
      :disabled="isSubmitting"
    >
      <span x-show="!isSubmitting">
        {leadForm ? '🎯 Anfrage senden' : '📧 Nachricht senden'}
      </span>
      <span x-show="isSubmitting" class="flex items-center space-x-2">
        <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span x-text="loadingText">Wird gesendet...</span>
      </span>
    </button>

    <!-- ✅ SUCCESS MESSAGE v18.9 (Verbessertes Design) -->
    <div 
      x-show="showSuccessMessage" 
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="opacity-0 transform translate-y-4"
      x-transition:enter-end="opacity-100 transform translate-y-0"
      class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-6 mt-6"
    >
      <div class="flex items-start space-x-3">
        <div class="text-green-500 text-2xl">✅</div>
        <div class="flex-1">
          <h3 class="text-lg font-semibold text-green-800 dark:text-green-200 mb-2" x-text="successTitle"></h3>
          <div class="text-green-700 dark:text-green-300 mb-4" x-html="successMessage"></div>
          
          <!-- ✅ E-MAIL STATUS v18.9 -->
          <div x-show="emailStatus" class="bg-white dark:bg-gray-800 rounded-lg p-4 border border-green-200 dark:border-green-700" x-transition>
            <div class="flex items-center space-x-2 mb-3">
              <span class="text-xl">📧</span>
              <strong class="text-gray-800 dark:text-gray-200">E-Mail-Status:</strong>
            </div>
            
            <!-- Bestätigungs-E-Mail -->
            <div x-show="emailStatus.confirmation" class="mb-2">
              <div class="flex items-center space-x-2">
                <span x-show="emailStatus.confirmation.sent" class="text-green-600">✅</span>
                <span x-show="!emailStatus.confirmation.sent" class="text-yellow-600">⚠️</span>
                <span class="text-sm text-gray-700 dark:text-gray-300">
                  <span x-show="emailStatus.confirmation.sent">Bestätigungs-E-Mail an Sie gesendet</span>
                  <span x-show="!emailStatus.confirmation.sent">Bestätigungs-E-Mail konnte nicht gesendet werden</span>
                </span>
              </div>
              <div class="text-xs text-gray-500 ml-6" x-text="emailStatus.confirmation.recipient"></div>
            </div>
            
            <!-- Admin-Benachrichtigung -->
            <div x-show="emailStatus.admin" class="mb-2">
              <div class="flex items-center space-x-2">
                <span x-show="emailStatus.admin.sent" class="text-green-600">✅</span>
                <span x-show="!emailStatus.admin.sent" class="text-yellow-600">⚠️</span>
                <span class="text-sm text-gray-700 dark:text-gray-300">
                  <span x-show="emailStatus.admin.sent">Admin-Benachrichtigung gesendet</span>
                  <span x-show="!emailStatus.admin.sent">Admin-Benachrichtigung fehlgeschlagen</span>
                </span>
                <span x-show="emailStatus.admin.priority === 'HIGH (Lead)'" class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">🎯 LEAD</span>
              </div>
            </div>
            
            <!-- E-Mail Fehler -->
            <div x-show="emailStatus.errors && emailStatus.errors.length > 0" class="mt-3 p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded border border-yellow-200 dark:border-yellow-800">
              <div class="text-sm font-medium text-yellow-800 dark:text-yellow-200 mb-1">⚠️ E-Mail-Probleme:</div>
              <template x-for="error in emailStatus.errors" :key="error">
                <div class="text-sm text-yellow-700 dark:text-yellow-300" x-text="error"></div>
              </template>
            </div>
          </div>
          
          <!-- Direkter Kontakt -->
          <div class="mt-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <p class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Alternativ erreichen Sie uns direkt:</p>
            <div class="flex flex-col sm:flex-row gap-3">
              <a href="tel:+497440913367" class="inline-flex items-center space-x-2 text-primary-gold hover:underline text-sm">
                <span>📞</span>
                <span>+49 7440 913367</span>
              </a>
              <a href="mailto:webmaster@maier-value.com" class="inline-flex items-center space-x-2 text-primary-gold hover:underline text-sm">
                <span>✉️</span>
                <span>webmaster@maier-value.com</span>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ✅ ERROR MESSAGE (Original Design) -->
    <div 
      x-show="showErrorMessage" 
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="opacity-0 transform translate-y-4"
      x-transition:enter-end="opacity-100 transform translate-y-0"
      class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-6 mt-6"
    >
      <div class="flex items-start space-x-3">
        <div class="text-red-500 text-2xl">❌</div>
        <div class="flex-1">
          <h3 class="text-lg font-semibold text-red-800 dark:text-red-200 mb-2">Fehler beim Senden</h3>
          <div class="text-red-700 dark:text-red-300 mb-4" x-html="errorMessage"></div>
          
          <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <p class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Bitte kontaktieren Sie uns direkt:</p>
            <div class="flex flex-col sm:flex-row gap-3">
              <a href="tel:+497440913367" class="inline-flex items-center space-x-2 text-primary-gold hover:underline text-sm">
                <span>📞</span>
                <span>+49 7440 913367</span>
              </a>
              <a href="mailto:webmaster@maier-value.com" class="inline-flex items-center space-x-2 text-primary-gold hover:underline text-sm">
                <span>✉️</span>
                <span>webmaster@maier-value.com</span>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<script define:vars={{ leadForm }}>
  function contactFormData() {
    return {
      // ✅ FORM DATA v18.9
      formData: {
        name: '',
        email: '',
        phone: '',
        message: '',
        gdprConsent: false,
        honeypot: '',
        leadForm: leadForm
      },
      
      // ✅ STATE MANAGEMENT v18.9
      isSubmitting: false,
      showSuccessMessage: false,
      showErrorMessage: false,
      loadingText: 'Wird gesendet...',
      
      // ✅ MESSAGES v18.9
      successTitle: '',
      successMessage: '',
      errorMessage: '',
      
      // ✅ E-MAIL STATUS v18.9
      emailStatus: null,
      
      // ✅ VALIDATION
      errors: {},

      // ✅ CLEAR FIELD ERROR
      clearFieldError(field) {
        delete this.errors[field];
      },

      // ✅ CLIENT-SIDE VALIDATION
      validateForm() {
        this.errors = {};
        let isValid = true;

        // Name validation
        if (!this.formData.name || this.formData.name.trim().length < 2) {
          this.errors.name = 'Name muss mindestens 2 Zeichen lang sein';
          isValid = false;
        } else if (this.formData.name.trim().length > 100) {
          this.errors.name = 'Name darf maximal 100 Zeichen lang sein';
          isValid = false;
        }

        // Email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!this.formData.email || !emailRegex.test(this.formData.email.trim())) {
          this.errors.email = 'Gültige E-Mail-Adresse erforderlich';
          isValid = false;
        } else if (this.formData.email.trim().length > 255) {
          this.errors.email = 'E-Mail-Adresse darf maximal 255 Zeichen lang sein';
          isValid = false;
        }

        // Phone validation
        if (!this.formData.phone || this.formData.phone.trim().length < 6) {
          this.errors.phone = 'Telefonnummer muss mindestens 6 Zeichen lang sein';
          isValid = false;
        } else if (this.formData.phone.trim().length > 25) {
          this.errors.phone = 'Telefonnummer darf maximal 25 Zeichen lang sein';
          isValid = false;
        }

        // Message validation (optional)
        if (this.formData.message && this.formData.message.trim().length > 2000) {
          this.errors.message = 'Nachricht darf maximal 2000 Zeichen lang sein';
          isValid = false;
        }

        // GDPR validation
        if (!this.formData.gdprConsent) {
          this.errors.gdprConsent = 'Zustimmung zur Datenschutzerklärung ist erforderlich';
          isValid = false;
        }

        return isValid;
      },

      // ✅ FORM SUBMISSION v18.9 mit E-Mail-Integration
      async submitForm() {
        console.log('📧 ContactForm v18.9: Submit started');
        
        // Reset states
        this.showSuccessMessage = false;
        this.showErrorMessage = false;
        this.emailStatus = null;
        
        // Validate form
        if (!this.validateForm()) {
          console.log('❌ Validation failed:', this.errors);
          return;
        }

        // Start submission
        this.isSubmitting = true;
        this.loadingText = 'Wird gesendet...';

        try {
          console.log('📤 Sending form data to API v18.9');
          
          const response = await fetch('/api/contact', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(this.formData)
          });

          const result = await response.json();
          console.log('📥 API Response v18.9:', result);

          if (result.success) {
            // ✅ SUCCESS HANDLING v18.9
            this.successTitle = this.formData.leadForm 
              ? '🎯 Lead-Anfrage erfolgreich gesendet!'
              : '✅ Nachricht erfolgreich gesendet!';
            
            this.successMessage = `
              <p><strong>Vielen Dank, ${this.formData.name}!</strong></p>
              <p>${result.message}</p>
              ${result.emails && result.emails.sent 
                ? '<p class="text-green-600 font-medium">📧 Sie erhalten in Kürze eine Bestätigungs-E-Mail.</p>'
                : '<p class="text-yellow-600 font-medium">⚠️ E-Mail-Versand hatte Probleme, aber Ihre Anfrage wurde gespeichert.</p>'
              }
            `;
            
            // ✅ E-MAIL STATUS SETZEN v18.9
            if (result.emails) {
              this.emailStatus = {
                confirmation: result.emails.confirmation || null,
                admin: result.emails.admin || null,
                errors: result.emails.errors || []
              };
            }
            
            this.showSuccessMessage = true;
            
            // Form zurücksetzen nach Erfolg
            setTimeout(() => {
              this.resetForm();
            }, 5000);

          } else {
            // ✅ ERROR HANDLING v18.9
            console.error('❌ API Error v18.9:', result);
            
            this.errorMessage = `
              <p><strong>${result.message || 'Ein Fehler ist aufgetreten'}</strong></p>
              ${result.errors && result.errors.length > 0 
                ? '<ul class="list-disc list-inside mt-2">' + result.errors.map(error => `<li>${error}</li>`).join('') + '</ul>'
                : ''
              }
            `;
            
            this.showErrorMessage = true;
          }

        } catch (error) {
          console.error('❌ Network Error v18.9:', error);
          
          this.errorMessage = `
            <p><strong>Verbindungsfehler</strong></p>
            <p>Die Nachricht konnte nicht gesendet werden. Bitte prüfen Sie Ihre Internetverbindung und versuchen Sie es erneut.</p>
          `;
          
          this.showErrorMessage = true;
        } finally {
          this.isSubmitting = false;
        }
      },

      // ✅ RESET FORM
      resetForm() {
        this.formData = {
          name: '',
          email: '',
          phone: '',
          message: '',
          gdprConsent: false,
          honeypot: '',
          leadForm: leadForm
        };
        this.errors = {};
        this.showSuccessMessage = false;
        this.showErrorMessage = false;
        this.emailStatus = null;
      }
    }
  }
</script>