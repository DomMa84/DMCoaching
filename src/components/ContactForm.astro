---
// src/components/ContactForm.astro v18.9 (E-Mail Integration)
// ContactForm - E-Mail Integration zu v18.8 hinzugef√ºgt
// ‚úÖ √ÑNDERUNGEN v18.9:
// - E-Mail-Status-Anzeige in Success-Message
// - Enhanced Response-Handling f√ºr E-Mail-Best√§tigung
// - Lead-Form Unterscheidung beibehalten
// - Original v18.8 Design UNVER√ÑNDERT
// - Integration mit contact.js v17.10 E-Mail-Features

export interface Props {
  title?: string;
  subtitle?: string;
  showMessage?: boolean;
  leadForm?: boolean;
  formId?: string;
}

const {
  title = "Kontakt aufnehmen",
  subtitle = "Lassen Sie uns √ºber Ihre Herausforderungen sprechen",
  showMessage = true,
  leadForm = false,
  formId = "contact-form"
} = Astro.props;

console.log('üìß ContactForm v18.9 loaded - E-Mail Integration erweitert');
---

<section class="py-16 bg-white dark:bg-gray-800">
  <div class="container mx-auto px-4">
    <div class="max-w-4xl mx-auto">
      
      <!-- Form Header -->
      <div class="text-center mb-8">
        <h2 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-4">
          {title}
        </h2>
        <p class="text-lg text-gray-600 dark:text-gray-300">
          {subtitle}
        </p>
      </div>

      <!-- Contact Form -->
      <div class="bg-gray-50 dark:bg-gray-900 rounded-xl shadow-lg p-8">
        <form 
          id={formId}
          x-data="{
            // Form State
            loading: false,
            submitted: false,
            success: false,
            error: '',
            
            // ‚úÖ NEW v18.9: E-Mail Status
            emailStatus: null,
            
            // Form Data
            formData: {
              name: '',
              email: '',
              phone: '',
              message: '',
              gdprConsent: false,
              leadForm: ' + JSON.stringify(leadForm) + `,
              honeypot: ''
            },
            
            // Validation
            errors: {},
            
            // API Integration v18.9 - Enhanced mit E-Mail-Handling
            async submitForm() {
              console.log('üì§ Submitting form v18.9 - E-Mail Integration');
              
              // Reset states
              this.loading = true;
              this.error = '';
              this.errors = {};
              this.emailStatus = null;
              
              try {
                // Client-side validation
                if (!this.validateForm()) {
                  this.loading = false;
                  return;
                }
                
                console.log('‚úÖ Form validation passed v18.9');
                console.log('üìä Form data:', {
                  name: this.formData.name,
                  email: this.formData.email,
                  phone: this.formData.phone,
                  hasMessage: !!this.formData.message,
                  gdprConsent: this.formData.gdprConsent,
                  leadForm: this.formData.leadForm,
                  honeypot: this.formData.honeypot
                });
                
                // API Call to contact.js v17.10
                const response = await fetch('/api/contact', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(this.formData)
                });
                
                console.log('üì• API Response status:', response.status);
                
                const result = await response.json();
                console.log('üìä API Response data v18.9:', result);
                
                if (response.ok && result.success) {
                  // ‚úÖ SUCCESS HANDLING v18.9 mit E-Mail-Status
                  this.success = true;
                  this.submitted = true;
                  this.error = '';
                  
                  // ‚úÖ E-Mail-Status setzen v18.9
                  if (result.emails) {
                    this.emailStatus = {
                      sent: result.emails.sent || false,
                      confirmation: result.emails.confirmation || null,
                      admin: result.emails.admin || null,
                      errors: result.emails.errors || []
                    };
                    
                    console.log('üìß E-Mail Status erfasst v18.9:', this.emailStatus);
                  }
                  
                  console.log('üéâ Form submitted successfully v18.9');
                  console.log('‚úÖ Success message:', result.message);
                  
                  // Reset form after successful submission
                  setTimeout(() => {
                    this.resetForm();
                  }, 8000); // L√§nger wegen E-Mail-Status-Anzeige
                  
                } else {
                  // Error handling
                  this.success = false;
                  this.error = result.message || 'Ein Fehler ist aufgetreten. Bitte versuchen Sie es erneut.';
                  
                  // Handle validation errors
                  if (result.errors) {
                    this.errors = result.errors;
                  }
                  
                  console.log('‚ùå Form submission failed v18.9');
                  console.log('‚ùå Error:', this.error);
                }
                
              } catch (error) {
                console.error('‚ùå Network error v18.9:', error);
                this.success = false;
                this.error = 'Verbindungsfehler. Bitte √ºberpr√ºfen Sie Ihre Internetverbindung und versuchen Sie es erneut.';
              }
              
              this.loading = false;
            },
            
            // Form Validation (unver√§ndert v18.8)
            validateForm() {
              this.errors = {};
              let isValid = true;
              
              // Name validation
              if (!this.formData.name || this.formData.name.trim().length < 2) {
                this.errors.name = 'Name ist erforderlich (mindestens 2 Zeichen)';
                isValid = false;
              }
              
              // Email validation
              const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;
              if (!this.formData.email || !emailRegex.test(this.formData.email)) {
                this.errors.email = 'G√ºltige E-Mail-Adresse erforderlich';
                isValid = false;
              }
              
              // Phone validation
              if (!this.formData.phone || this.formData.phone.trim().length < 6) {
                this.errors.phone = 'Telefonnummer ist erforderlich (mindestens 6 Zeichen)';
                isValid = false;
              }
              
              // GDPR validation
              if (!this.formData.gdprConsent) {
                this.errors.gdpr = 'Zustimmung zur Datenschutzerkl√§rung ist erforderlich';
                isValid = false;
              }
              
              console.log('üîç Validation result v18.9:', { isValid, errors: this.errors });
              return isValid;
            },
            
            // Reset Form v18.9
            resetForm() {
              this.formData = {
                name: '',
                email: '',
                phone: '',
                message: '',
                gdprConsent: false,
                leadForm: ' + JSON.stringify(leadForm) + `,
                honeypot: ''
              };
              this.errors = {};
              this.loading = false;
              this.submitted = false;
              this.success = false;
              this.error = '';
              this.emailStatus = null; // ‚úÖ NEW v18.9
              
              console.log('üîÑ Form reset v18.9');
            },
            
            // Input handlers
            clearError(field) {
              delete this.errors[field];
            }
          }"
          @submit.prevent="submitForm()"
          class="space-y-6"
        >
          
          <!-- ‚úÖ SUCCESS MESSAGE v18.9 - Enhanced mit E-Mail-Status -->
          <div x-show="success" x-transition class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4 mb-6">
            <div class="flex items-start space-x-3">
              <div class="text-green-600 dark:text-green-400 text-2xl">‚úÖ</div>
              <div class="flex-1">
                <h3 class="text-green-800 dark:text-green-200 font-semibold">
                  <span x-text="formData.leadForm ? 'üéØ Lead-Anfrage erfolgreich gesendet!' : 'Nachricht erfolgreich gesendet!'"></span>
                </h3>
                <p class="text-green-700 dark:text-green-300 text-sm mt-1">
                  Vielen Dank f√ºr Ihre Nachricht. Wir melden uns schnellstm√∂glich bei Ihnen.
                </p>
                
                <!-- ‚úÖ E-MAIL STATUS ANZEIGE v18.9 -->
                <div x-show="emailStatus" class="mt-3 p-3 bg-white dark:bg-gray-800 rounded border border-green-200 dark:border-green-700" x-transition>
                  <div class="flex items-center space-x-2 mb-2">
                    <span class="text-lg">üìß</span>
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">E-Mail-Status:</span>
                  </div>
                  
                  <!-- Best√§tigung an User -->
                  <div x-show="emailStatus && emailStatus.confirmation" class="text-xs space-y-1">
                    <div class="flex items-center space-x-2">
                      <span x-show="emailStatus.confirmation.sent" class="text-green-600">‚úÖ</span>
                      <span x-show="!emailStatus.confirmation.sent" class="text-yellow-600">‚ö†Ô∏è</span>
                      <span class="text-gray-600 dark:text-gray-400">
                        <span x-show="emailStatus.confirmation.sent">Best√§tigungs-E-Mail an Sie gesendet</span>
                        <span x-show="!emailStatus.confirmation.sent">Best√§tigung konnte nicht gesendet werden</span>
                      </span>
                    </div>
                  </div>
                  
                  <!-- Admin-Benachrichtigung -->
                  <div x-show="emailStatus && emailStatus.admin" class="text-xs space-y-1">
                    <div class="flex items-center space-x-2">
                      <span x-show="emailStatus.admin.sent" class="text-green-600">‚úÖ</span>
                      <span x-show="!emailStatus.admin.sent" class="text-yellow-600">‚ö†Ô∏è</span>
                      <span class="text-gray-600 dark:text-gray-400">
                        <span x-show="emailStatus.admin.sent">Admin-Benachrichtigung gesendet</span>
                        <span x-show="!emailStatus.admin.sent">Admin-Benachrichtigung fehlgeschlagen</span>
                      </span>
                      <span x-show="emailStatus.admin.priority === 'HIGH (Lead)'" class="bg-blue-100 text-blue-800 text-xs px-1 py-0.5 rounded">üéØ</span>
                    </div>
                  </div>
                  
                  <!-- E-Mail Errors -->
                  <div x-show="emailStatus && emailStatus.errors && emailStatus.errors.length > 0" class="mt-2 text-xs">
                    <div class="text-yellow-700 dark:text-yellow-300 font-medium">‚ö†Ô∏è E-Mail-Probleme:</div>
                    <template x-for="error in emailStatus.errors">
                      <div class="text-yellow-600 dark:text-yellow-400" x-text="error"></div>
                    </template>
                  </div>
                  
                  <!-- Backup-Kontakt bei E-Mail-Problemen -->
                  <div x-show="emailStatus && (!emailStatus.sent || emailStatus.errors.length > 0)" class="mt-2 pt-2 border-t border-green-200 dark:border-green-700">
                    <p class="text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Direkter Kontakt:</p>
                    <div class="flex flex-col space-y-1">
                      <a href="tel:+497440913367" class="text-xs text-green-600 hover:underline">üìû +49 7440 913367</a>
                      <a href="mailto:webmaster@maier-value.com" class="text-xs text-green-600 hover:underline">‚úâÔ∏è webmaster@maier-value.com</a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Error Message (unver√§ndert v18.8) -->
          <div x-show="error && !success" x-transition class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 mb-6">
            <div class="flex items-center">
              <div class="text-red-600 dark:text-red-400 text-2xl mr-3">‚ùå</div>
              <div>
                <h3 class="text-red-800 dark:text-red-200 font-semibold">Fehler beim Senden</h3>
                <p class="text-red-700 dark:text-red-300 text-sm mt-1" x-text="error"></p>
                
                <!-- Backup Contact Info -->
                <div class="mt-3 p-3 bg-gray-50 dark:bg-gray-800 rounded border">
                  <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Kontaktieren Sie uns direkt:</p>
                  <div class="space-y-1">
                    <a href="tel:+497440913367" class="block text-sm text-blue-600 hover:underline">üìû +49 7440 913367</a>
                    <a href="mailto:webmaster@maier-value.com" class="block text-sm text-blue-600 hover:underline">‚úâÔ∏è webmaster@maier-value.com</a>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Honeypot Field (unsichtbar) -->
          <input 
            type="text" 
            name="website" 
            x-model="formData.honeypot"
            style="display: none !important;" 
            tabindex="-1" 
            autocomplete="off"
          >

          <!-- Name Field -->
          <div>
            <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Name <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="name"
              name="name"
              x-model="formData.name"
              @input="clearError('name')"
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:text-white transition-colors"
              :class="errors.name ? 'border-red-500' : ''"
              placeholder="Ihr vollst√§ndiger Name"
              required
            >
            <div x-show="errors.name" class="text-red-500 text-sm mt-1" x-text="errors.name"></div>
          </div>

          <!-- Email Field -->
          <div>
            <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              E-Mail-Adresse <span class="text-red-500">*</span>
            </label>
            <input
              type="email"
              id="email"
              name="email"
              x-model="formData.email"
              @input="clearError('email')"
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:text-white transition-colors"
              :class="errors.email ? 'border-red-500' : ''"
              placeholder="ihre.email@beispiel.de"
              required
            >
            <div x-show="errors.email" class="text-red-500 text-sm mt-1" x-text="errors.email"></div>
          </div>

          <!-- Phone Field -->
          <div>
            <label for="phone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Telefonnummer <span class="text-red-500">*</span>
            </label>
            <input
              type="tel"
              id="phone"
              name="phone"
              x-model="formData.phone"
              @input="clearError('phone')"
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:text-white transition-colors"
              :class="errors.phone ? 'border-red-500' : ''"
              placeholder="+49 123 456789"
              required
            >
            <div x-show="errors.phone" class="text-red-500 text-sm mt-1" x-text="errors.phone"></div>
          </div>

          <!-- Message Field -->
          {showMessage && (
            <div>
              <label for="message" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                {leadForm ? 'Beschreiben Sie Ihre Herausforderung' : 'Nachricht'} 
                {!leadForm && <span class="text-gray-500">(optional)</span>}
              </label>
              <textarea
                id="message"
                name="message"
                x-model="formData.message"
                rows="4"
                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:text-white transition-colors resize-none"
                placeholder={leadForm 
                  ? "Beschreiben Sie kurz Ihre aktuelle Situation und wobei wir Ihnen helfen k√∂nnen..."
                  : "Ihre Nachricht an uns..."
                }
              ></textarea>
              <div class="text-right text-sm text-gray-500 mt-1">
                <span x-text="formData.message.length"></span>/2000 Zeichen
              </div>
            </div>
          )}

          <!-- GDPR Checkbox -->
          <div>
            <label class="flex items-start space-x-3">
              <input
                type="checkbox"
                name="gdprConsent"
                x-model="formData.gdprConsent"
                @change="clearError('gdpr')"
                class="mt-1 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                :class="errors.gdpr ? 'border-red-500' : ''"
                required
              >
              <span class="text-sm text-gray-600 dark:text-gray-300">
                Ich stimme der <a href="/datenschutz" target="_blank" class="text-blue-600 hover:underline">Datenschutzerkl√§rung</a> zu und bin damit einverstanden, dass meine Daten zur Bearbeitung meiner Anfrage gespeichert werden. <span class="text-red-500">*</span>
              </span>
            </label>
            <div x-show="errors.gdpr" class="text-red-500 text-sm mt-1" x-text="errors.gdpr"></div>
          </div>

          <!-- Submit Button -->
          <button
            type="submit"
            :disabled="loading"
            class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center space-x-2"
          >
            <span x-show="!loading" x-text="leadForm ? 'üéØ Anfrage senden' : 'üìß Nachricht senden'"></span>
            <span x-show="loading" class="flex items-center space-x-2">
              <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <span>Wird gesendet...</span>
            </span>
          </button>

        </form>
      </div>
    </div>
  </div>
</section>